[gcode_macro M84]
description: Disable steppers
variable_timer_params: ""
rename_existing: M84.1
gcode:
    {% set timer_params = rawparams %}
    SET_GCODE_VARIABLE MACRO=M84 VARIABLE=timer_params VALUE="'{timer_params}'" ; Set timer params
    { action_respond_info("rawparams: %s" % (timer_params)) }
    {% set step_delay = params.S|default(0)|int %}
    {% if step_delay > 0 %}
        UPDATE_DELAYED_GCODE ID=stepper_timer DURATION={step_delay}
        { action_respond_info("timer started: %d" % (step_delay)) }
    {% else %}
        {% if "X" in rawparams%} SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0 {% endif %}
        {% if "Y" in rawparams%} SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0 {% endif %}
        {% if "Z" in rawparams%} SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=0 {% endif %}
        {% if "E" in rawparams%} SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0 {% endif %}
        {% if rawparams == "" %} M84.1 {% endif %}
    {% endif %}

[gcode_macro M18]
description: Disable steppers
rename_existing: M18.1
gcode:
    M84 {rawparams}

[delayed_gcode stepper_timer]
initial_duration: 0.0
gcode:
    {% set timer_params = printer['gcode_macro M84'].timer_params %}
    { action_respond_info("Stepper timer expired.") }
    { action_respond_info("params: %s" % (timer_params)) }
    {% if "X" in timer_params%} SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0 {% endif %}
    {% if "Y" in timer_params%} SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0 {% endif %}
    {% if "Z" in timer_params%} SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=0 {% endif %}
    {% if "E" in timer_params%} SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0 {% endif %}
    UPDATE_DELAYED_GCODE ID=stepper_timer DURATION=0